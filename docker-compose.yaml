services:
  db:
    image: mysql:8.4
    container_name: kainban-db
    restart: on-failure
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword        # dev only â€“ move to secrets later
      MYSQL_DATABASE: kainban
      MYSQL_USER: kainban_user
      MYSQL_PASSWORD: kainban_pass
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3307:3306"
    networks:
      - backend-db

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: kainban-backend
    restart: on-failure
    environment:
      DATABASE_URL: mysql://kainban_user:kainban_pass@db:3306/kainban
    depends_on:
      - db
    ports:
      - "8080:8080"
    networks:
      - agent-backend
      - backend-db
      - public

  codex-agent:
    build:
      context: ./agent/codex
      dockerfile: Dockerfile
    environment:
      OPENAI_API_KEY_FILE: /run/secrets/openai_apikey
    secrets:
      - openai_apikey
    volumes:
      - workspace:/workspace
    tty: true
    stdin_open: true
    restart: no
    networks:
      - agent-backend

  migrate:
    image: rust:1.76
    command: ["sh", "-c", "sqlx migrate run"]
    volumes:
      - ./backend:/app
    working_dir: /app
    environment:
      DATABASE_URL: mysql://kainban_user:kainban_pass@db:3306/kainban
    depends_on:
      - db
    networks:
      - backend-db

secrets:
  openai_apikey:
    file: ./secrets/openai_apikey

volumes:
  workspace:
  db_data:

networks:
  backend-db:
    driver: bridge
  public:
    driver: bridge
  agent-backend:
    driver: bridge
